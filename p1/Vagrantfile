Vagrant.configure(2) do |config|
    config.vm.box = "generic/debian12"

    server_ip = "192.168.56.110"
    token_path = "/vagrant_share/token"

    config.vm.define "psimonen" do |psimonen|
        psimonen.vm.provider "virtualbox" do |v|
            v.memory = 1024
            v.cpus = 1
        end
        psimonen.vm.hostname = "psimonenS"
        psimonen.vm.network "private_network", ip: server_ip, hostname: true
        psimonen.vm.synced_folder "./confs", "/vagrant_share"
        psimonen.vm.provision "shell", inline: <<-SHELL
            echo 'k3s server'
            export INSTALL_K3S_EXEC="--bind-address #{server_ip} --flannel-iface eth1"
            curl -sfL https://get.k3s.io | sh -
            sleep 5
            cp /var/lib/rancher/k3s/server/node-token "#{token_path}"
            cp /etc/rancher/k3s/k3s.yaml /vagrant_share/
            SHELL
    end

    config.vm.define "valmpani" do |valmpani|
        valmpani.vm.provider "virtualbox" do |v|
            v.memory = 512
            v.cpus = 1
        end
        valmpani.vm.hostname = "valmpaniSW"
        valmpani.vm.network "private_network", ip: "192.168.56.111", hostname: true
        valmpani.vm.synced_folder "./confs", "/vagrant_share"
        valmpani.vm.provision "shell", inline: <<-SHELL
            echo 'k3s agent'
            export K3S_TOKEN_FILE="#{token_path}"
            export K3S_URL="https://#{server_ip}:6443"
            export INSTALL_K3S_EXEC="--flannel-iface eth1"
            curl -sfL https://get.k3s.io | sh -
            SHELL
    end
end
